---
title: 模型/函数/权重字典
date: '2025-08-05 18:00:11'
updated: '2025-08-22 20:35:03'
categories:
  - 人工智能
tags:
  - 深度学习
  - TubeDETR
cover: /images/custom-cover.jpg
recommend: true
---
```python


def build(args):
    """构建TubeDETR模型、损失函数和权重字典的核心函数
    Args:
        args: 包含所有配置参数的命名空间，例如：
            - device: 计算设备(cpu/cuda)
            - num_queries: 查询向量数量 default=1 "Number of object query slots per image"
            - video_max_len_train: 训练时最大视频长度  default=200
            - stride: 时间采样步长	 default=5
    Returns:
        model: 构建好的TubeDETR实例
        criterion: 损失计算模块
        weight_dict: 各损失项的权重配置
    """
    device = torch.device(args.device)  # 设置计算设备

    backbone = build_backbone(args)  
    

    transformer = build_transformer(args)

    model = TubeDETR(
        backbone,
        transformer,
        num_queries=args.num_queries,  # 默认1个空间查询
        aux_loss=args.aux_loss,  # 是否使用辅助损失
        video_max_len=args.video_max_len_train,  # 最大帧数(如200)
        stride=args.stride,  # 时间采样步长(如5)
        guided_attn=args.guided_attn,  # 是否使用引导注意力
        fast=args.fast,  # 是否启用快速分支
        fast_mode=args.fast_mode,  # 快速分支类型(gating/transformer)
        sted=args.sted,  # 是否预测起止时间
    )
    weight_dict = {
        "loss_bbox": args.bbox_loss_coef,  # 边界框回归损失权重(默认5)
        "loss_giou": args.giou_loss_coef,  # GIoU损失权重(默认2)
        "loss_sted": args.sted_loss_coef,  # 时间边界损失权重(默认1)
    }
    if args.guided_attn:
        weight_dict["loss_guided_attn"] = args.guided_attn_loss_coef  # 引导注意力损失

    if args.aux_loss:
        aux_weight_dict = {}
        for i in range(args.dec_layers - 1):
            aux_weight_dict.update({k + f"_{i}": v for k, v in weight_dict.items()})
        weight_dict.update(aux_weight_dict)
    """辅助损失策略:
    为每个解码器中间层(前5层)添加相同的损失项
    例如: loss_bbox_0, loss_giou_0, ..., loss_bbox_4
    作用: 缓解梯度消失，加强深层监督(类似DeepLabv3+)
    """

    losses = ["boxes", "sted"] if args.sted else ["boxes"]  # 基础损失项
    if args.guided_attn:
        losses += ["guided_attn"]  # 添加引导注意力损失

    criterion = SetCriterion(
        losses=losses,
        sigma=args.sigma,  # 时间边界预测的高斯标准差(默认0.7)
    )
    criterion.to(device)
    """SetCriterion关键功能:
    1. 计算空间定位损失:
       - L1损失 + GIoU损失(边界框)
    2. 计算时间定位损失:
       - 起止时间的KL散度(论文式1)
    3. 引导注意力损失(如果启用):
       - 惩罚非目标区域的注意力权重
    """

    return model, criterion, weight_dict
    """返回三元组用于训练:
    - model: 可调用的TubeDETR模型
    - criterion: 损失计算模块 
    - weight_dict: 各损失项权重配置
    典型训练循环示例:
    outputs = model(videos, texts)
    losses = criterion(outputs, targets)
    total_loss = sum(losses[k] * weight_dict[k] for k in losses.keys())
    """
```
